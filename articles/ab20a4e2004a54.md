---
title: "WSL + Arch Linux + home-managerで環境構築してみた"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [wsl, nix]
published: true
---

## はじめに

WSL のディストリビューションはこれまで Ubuntu や Debian を使っていましたが、ドライブを圧迫してきたため再インストールを試みました。
どうせ再インストールするなら最小構成でスッキリさせたいと思い、Arch Linux で環境構築をしてみたので手順を共有します。

Arch Linuxは最小構成がいいところではありますが、必要なパッケージを環境構築ごとにインストールするのは、何を入れなければいけないのか忘れることがあり面倒です。
したがって、**nix + home-manager** を使って、宣言的に環境を管理する構成にし、再利用性を高めることにしました。

※ NixOSはWSLに入れるのが大変なので、Arch Linux + nix を用いています。

## 前提環境

| 項目 | 内容 |
|------|------|
| OS | Windows 11 |
| WSL | WSL 2 |
| ディストリビューション | Arch Linux |
| nix インストーラ | Determinate Nix Installer |
| 環境管理 | home-manager |

## 手順

### 1. Arch Linux のインストール

```bash
wsl --install archlinux
```

### 2. 初期設定

インストール直後は root ユーザーでログインした状態になります。以下の順で初期設定を進めます。

**パッケージの更新とインストール**

pacmanのミラーリストを更新し、nix をインストールするために必要なパッケージを入れておきます。

```bash
pacman -Syyu
pacman -S sudo vim curl git
```

**ユーザーの作成**

ユーザ名は `wslUser` としています。必要に応じて変更してください。

```bash
useradd -m -G wheel -s /bin/bash wslUser
passwd wslUser
```

**sudo の設定**

```bash
EDITOR=vim visudo
```

`visudo` を開いたら、以下の行のコメントアウトを外します。

```
%wheel ALL=(ALL) ALL
```

**デフォルトユーザーの設定**

`/etc/wsl.conf` を作成・編集し、WSL 起動時のデフォルトユーザーを指定します。

```ini
[user]
default = wslUser
```

設定後、WSL を再起動して反映させます。

```bash
wsl --shutdown
wsl
```

### 3. nix のインストール

[Determinate Systems の nix-installer](https://github.com/DeterminateSystems/nix-installer) を使います。公式インストーラよりもflake機能が最初から有効になっているなど、便利です。

```bash
curl -fsSL https://install.determinate.systems/nix | sh -s -- install
```

インストール後、シェルを再起動して nix コマンドが使えることを確認します。

```bash
nix --version
```

### 4. home-manager の設定

home-manager を使って、パッケージや dotfiles を宣言的に管理します。

**設定ファイルの準備**

`~/.config/home-manager/` 以下を設定します。
- flake.nix: home-manager のフレーク定義ファイル
- home.nix: home-manager の設定ファイル

自分はdotfilesのように、home-manager用のリポジトリを作成しクローンするようにしました。

https://github.com/Coxless/home-manager

一から設定する場合は、以下でテンプレートを生成できるのでそれを編集してください。

```bash
nix run home-manager/master -- init --switch
```

#### 参考情報

home-manager公式マニュアル:
https://nix-community.github.io/home-manager/

参考になる記事:
https://blog.tomoyukim.net/entry/nix-flake-home-manager/

### 5. home-managerの適用

```bash
nix run home-manager/master -- switch
home-manager switch # 二回目以降
```

![home-manager switchが成功した際の様子](/images/ab20a4e2004a54/home-manager-switch.png)

## まとめと感想

- **Arch Linux** は Ubuntu より軽量で、不要なパッケージが少ない分スッキリしています
- **nix + home-manager** を使うことで、`home.nix` を Git 管理するだけで環境を再現できるのが便利です
- 初期設定の手間はありますが、一度構築してしまえばあとは `home-manager switch` だけで済むのは楽でした。
- 記事作成にあたり、何度かこの手順で環境構築しましたが、かなりスムーズに構築できたため満足しています。
