---
title: "git worktreeでClaude Codeの並列開発を快適に！wtenvツールを作ってみた"
emoji: "🌲"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["git", "rust", "claudecode", "cli", "開発環境"]
published: false
---

# はじめに

Claude Codeを使っていると、複数のタスクを並行して進めたい場面がよくあります。例えば、

- タスクAでテストを実行している間に、別のタスクBのコードレビューをしたい
- 長時間かかるビルド中に、別の機能開発を始めたい
- 複数のブランチでClaude Codeのセッションを同時に開きたい

こういった並列開発の課題を解決するために、**git worktree**と**wtenv**というツールを活用する方法を紹介します。

# git worktreeとは

`git worktree`は、Gitの公式機能で、1つのリポジトリから複数の作業ディレクトリ（ワークツリー）を作成できる機能です。

通常、git checkoutで別ブランチに切り替えると、作業中のファイルが変わってしまいますが、git worktreeを使えば、各ブランチを別々のディレクトリで独立して扱えます。

```bash
# 従来のブランチ切り替え（作業が中断される）
git checkout feature-a
# 作業中...
git checkout feature-b  # feature-aの作業が中断される

# worktreeを使う場合（両方同時に作業できる）
git worktree add ../feature-a feature-a
git worktree add ../feature-b feature-b
# 両方のディレクトリで同時に作業可能！
```

# wtenvツールの紹介

git worktreeは便利ですが、毎回手動でコマンドを実行したり、環境ファイル（`.env`など）をコピーしたり、セットアップコマンドを実行したりするのは面倒です。

そこで作ったのが**wtenv**です。

https://github.com/Coxless/wtenv

wtenvは、Rustで開発したgit worktree管理ツールで、以下の機能を提供します：

- **対話的なworktree作成**: ブランチ名を選択して簡単に作成
- **環境ファイルの自動コピー**: `.env`などを自動的に新しいworktreeにコピー
- **セットアップコマンドの自動実行**: `npm install`などを自動で実行
- **視覚的なフィードバック**: 進捗バーやカラー出力で分かりやすい

:::message
このツールはまだ開発中（unstable）です。予告なく破壊的な変更が入る可能性があるのでご注意ください。
:::

# インストール方法

## Cargoからインストール

Rustがインストールされている場合、cargoから直接インストールできます：

```bash
cargo install wtenv
```

## ソースからビルド

```bash
git clone https://github.com/Coxless/wtenv.git
cd wtenv
cargo build --release
# バイナリは target/release/wtenv に生成されます
```

インストール後、`wtenv --version`でバージョンが表示されれば成功です。

# 基本的な使い方

## 1. 初期化

まず、プロジェクトのルートディレクトリで初期化します：

```bash
wtenv init
```

これで`.worktree.yml`という設定ファイルが生成されます。

## 2. worktreeの作成

対話的にworktreeを作成：

```bash
wtenv create
```

ブランチ名を指定して作成：

```bash
wtenv create feature-auth
```

パスも指定：

```bash
wtenv create feature-auth ~/projects/myapp-feature-auth
```

## 3. worktreeの一覧表示

```bash
wtenv list

# 詳細表示
wtenv list --verbose
```

## 4. worktreeの削除

```bash
wtenv remove ../feature-auth

# 強制削除
wtenv remove ../feature-auth --force
```

# 設定ファイルの活用

`.worktree.yml`を編集することで、worktree作成時の動作をカスタマイズできます。

```yaml
# コピーするファイル（globパターンが使えます）
copy:
  - .env
  - .env.local
  - .vscode/settings.json

# 除外するファイル
exclude:
  - .env.production

# worktree作成後に実行するコマンド
postCreate:
  - command: pnpm install
    description: "依存関係をインストール中..."
    optional: false

  - command: pnpm build
    description: "初回ビルド実行中..."
    optional: true
```

`postCreate`では、各コマンドに説明（description）やオプション指定（optional）を付けられます。`optional: true`にすると、コマンドが失敗してもworktree作成自体は継続されます。

# Claude Codeとの組み合わせ

wtenvとClaude Codeを組み合わせると、以下のような並列開発ワークフローが実現できます：

## ワークフロー例

```bash
# プロジェクトのルートディレクトリで
cd ~/projects/myapp

# worktreeを作成
wtenv create feature-a
wtenv create feature-b

# それぞれのディレクトリでClaude Codeセッションを開く
cd ../myapp-feature-a
claude-code  # または VS Code + Claude Code

# 別のターミナルで
cd ~/projects/myapp-feature-b
claude-code
```

これで、2つのClaude Codeセッションが独立して動作します：

- セッション1では`feature-a`でテストを実行
- セッション2では`feature-b`でコードレビュー

どちらも同じリポジトリの異なるブランチで、互いに干渉せずに作業できます。

## Claude Codeの並列セッションのメリット

1. **待ち時間の削減**: 長時間タスクの実行中に別の作業ができる
2. **コンテキストスイッチのコスト削減**: ブランチ切り替えでファイルが変わらない
3. **複数タスクの同時進行**: 異なる機能開発を並行して進められる

# 実装の工夫

wtenvを実装する際に工夫した点をいくつか紹介します。

## Rustでの実装理由

- **シングルバイナリ配布**: 依存関係なく1つのバイナリで動作
- **クロスプラットフォーム**: Linux、macOS、Windowsで動作
- **高速**: git操作やファイルコピーが高速

## 主要なクレート

- `clap`: CLI引数のパースと対話的インターフェース
- `serde_yaml`: 設定ファイルの読み書き
- `indicatif`: プログレスバー表示
- `colored`: カラー出力

## エラーハンドリング

Rustの`Result`型を活用して、エラーをユーザーフレンドリーに表示するようにしています：

```rust
// エラーが発生した場合でも、分かりやすいメッセージを表示
if let Err(e) = create_worktree(&config) {
    eprintln!("❌ エラー: {}", e);
    std::process::exit(1);
}
```

# 今後の展望

wtenvはまだ開発初期段階ですが、今後以下のような機能を追加していきたいと考えています：

- [ ] worktree間の環境変数の差分管理
- [ ] テンプレート機能（プロジェクトタイプごとの設定プリセット）
- [ ] GUIサポート（TUI）
- [ ] Claude Codeとのより深い統合

# まとめ

git worktreeとwtenvを使うことで、Claude Codeでの並列開発がとても快適になります。

- **git worktree**: 複数のブランチを独立したディレクトリで管理
- **wtenv**: worktreeの作成・管理を自動化
- **Claude Code**: 各worktreeで独立したAIセッションを実行

特にClaude Codeのような長時間実行されるタスクが多い開発環境では、この組み合わせが非常に効果的です。

ぜひ試してみてください！

# 参考リンク

- [wtenv GitHubリポジトリ](https://github.com/Coxless/wtenv)
- [Git worktree 公式ドキュメント](https://git-scm.com/docs/git-worktree)
- [Claude Code](https://www.anthropic.com/claude/code)
